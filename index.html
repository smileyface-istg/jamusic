<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaMusic v2 | Premium Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #00081C;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --card-bg: rgba(15, 23, 42, 0.6);
            --sidebar-width: 280px;
        }

        /* Prevent keyboard on mobile for buttons */
        button, [role="button"] {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none !important;
        }
        
        /* Force no keyboard on mobile inputs unless explicitly allowed */
        @media (max-width: 768px) {
            input:not([type="text"]):not([type="password"]):not([type="email"]):not([type="search"]):not([type="range"]) {
                pointer-events: none;
            }
            /* Specifically target buttons to ensure they don't trigger keyboard */
            button {
                touch-action: manipulation;
            }
            /* Force hide display name on mobile initially */
            #displayname-modal, #displayname-overlay {
                display: none !important;
            }
            #displayname-modal.show, #displayname-overlay.show {
                display: block !important;
            }
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            margin: 0;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-active {
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.15) 0%, rgba(56, 189, 248, 0) 100%);
            color: var(--accent);
            border-left: 3px solid var(--accent);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .music-card {
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            z-index: 10;
        }

        .music-card:hover {
            transform: translateY(-10px) scale(1.02);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .play-btn-float {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .music-card:hover .play-btn-float {
            opacity: 1;
            transform: translateY(0);
        }

        #auth-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: radial-gradient(circle at top right, #0f172a, #00081C);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #main-app.hidden-state {
            pointer-events: none;
            user-select: none;
            filter: blur(15px);
            opacity: 0;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .visualizer-bar {
            transition: height 0.1s ease;
        }

        .tab-btn {
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #cbd5e1;
            padding: .4rem .5rem;
            background: transparent;
            border-radius: .5rem;
        }
        .tab-btn.active {
            border-color: var(--accent);
            color: white;
        }

        /* Dropdown Styles */
        .profile-dropdown {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s ease;
        }
        .profile-dropdown.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Settings Sidebar */
        #settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 990;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }
        #settings-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        #settings-sidebar {
            position: fixed;
            top: 0;
            right: -420px;
            height: 100%;
            width: 320px;
            max-width: calc(100% - 24px);
            z-index: 1000;
            transition: right .35s cubic-bezier(.2,.9,.2,1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #settings-sidebar.open {
            right: 0;
        }

        /* Display Name Modal (re-usable) */
        #displayname-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #displayname-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .displayname-modal {
            width: 420px;
            max-width: 92%;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.06);
            transform: translateY(12px) scale(.98);
            opacity: 0;
            transition: all .28s cubic-bezier(.2,.9,.2,1);
            box-shadow: 0 10px 30px rgba(2,6,23,0.6);
        }
        .displayname-modal.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .dn-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

        .dn-input { width:100%; padding:10px 12px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); border-radius:10px; color:inherit; }

        .dn-error { color:#ffb3b3; font-size:13px; margin-top:8px; }

        /* prevent page zoom weirdness small screens */
        @media (max-width: 640px) {
            #settings-sidebar { width: 92%; }
            .displayname-modal { width: 92%; }
        }

        /* Mobile Player Bar Fixes */
        @media (max-width: 768px) {
            #player-bar {
                padding: 10px 12px;
                height: 72px; /* Fixed height for a compact feel */
                bottom: 64px; /* Above mobile bottom nav */
                display: flex;
                align-items: center;
            }
            #player-bar .max-w-\[1800px\] {
                display: flex;
                flex-direction: row; /* Horizontal layout */
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 8px;
            }
            #player-bar .grid-cols-3 {
                display: contents; /* Break the grid for flex layout */
            }
            /* Left side: Image + Title/Artist */
            #player-bar .flex.items-center.gap-4.min-w-0 {
                flex: 1;
                gap: 10px;
                order: 1;
                overflow: hidden;
            }
            #player-img {
                width: 44px;
                height: 44px;
                border-radius: 8px;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            #player-title {
                font-size: 13px;
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: 700;
            }
            #player-artist {
                font-size: 11px;
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: rgba(255,255,255,0.5);
            }
            /* Middle side: Controls (compact) */
            #player-bar .flex.flex-col.items-center.gap-1\.5.w-full {
                width: auto;
                flex-direction: row;
                gap: 12px;
                order: 2; /* Put controls in the middle */
            }
            #player-bar .flex.items-center.gap-4.lg\:gap-8 {
                gap: 10px;
            }
            #player-bar button[onclick="prevTrack()"], 
            #player-bar button[onclick="nextTrack()"] {
                padding: 4px;
            }
            #player-bar button[onclick="prevTrack()"] svg, 
            #player-bar button[onclick="nextTrack()"] svg {
                width: 20px;
                height: 20px;
            }
            #play-pause-btn {
                width: 36px;
                height: 36px;
            }
            #play-pause-btn svg {
                width: 20px;
                height: 20px;
            }
            /* Progress bar and time - hidden or minimized on mobile bar to save space */
            #player-bar .flex.items-center.gap-2.w-full.max-w-\[600px\] {
                position: absolute;
                top: 0; /* Align with the top edge of the bar */
                left: 0;
                right: 0;
                max-width: none;
                padding: 0;
                gap: 0;
                z-index: 10;
            }
            #progress-bar-fill {
                height: 3px !important;
                background-color: #1db954 !important; /* Spotify green */
            }
            #seek-slider {
                height: 6px !important;
            }
            #seek-thumb {
                display: none !important;
            }
            #curr-time, #dur-time {
                display: none !important;
            }
            #player-bar .group.relative.flex-1.h-1.flex.items-center {
                height: 3px;
            }
            /* Right side: Extras (lyrics only on mobile) */
            #player-bar .flex.items-center.justify-end.gap-3.lg\:gap-5.min-w-0 {
                width: auto;
                gap: 8px;
                order: 3;
            }
            #lyrics-btn {
                padding: 6px !important;
            }
            #lyrics-btn svg {
                width: 18px;
                height: 18px;
            }
            #volume-slider-container {
                display: none; /* Hide volume on mobile bar to keep it comfy */
            }
        }

        .no-scroll { overflow: hidden !important; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* Lyrics Overlay */
        #lyrics-overlay {
            position: fixed;
            inset: 0;
            background: #00081C; /* Exact green */
            z-index: 2000;
            display: none;
            flex-direction: column;
            padding: 0;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.5s cubic-bezier(0.3, 0, 0, 1), transform 0.5s cubic-bezier(0.3, 0, 0, 1);
        }

        #lyrics-overlay.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        #lyrics-close {
            position: absolute;
            top: 40px;
            right: 40px;
            font-size: 40px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            z-index: 2002;
            transition: color 0.2s;
        }

        #lyrics-close:hover {
            color: #fff;
        }

        .lyrics-container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            padding: 15vh 40px 150px 40px; /* Adjusted for static display & player bar */
            scroll-behavior: smooth;
        }

        .lyrics-container::-webkit-scrollbar { display: none; }

        .lyric-line {
            font-size: 3rem;
            line-height: 1.2;
            font-weight: 900;
            padding: 16px 0;
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.6s cubic-bezier(0.3, 0, 0, 1);
            cursor: pointer;
            transform-origin: left;
            letter-spacing: -0.03em;
            text-align: left;
            will-change: transform, color, opacity;
        }

        .lyric-line.active {
            color: #ffffff;
            transform: scale(1.03);
            opacity: 1;
        }

        .lyric-line.passed {
            color: rgba(255, 255, 255, 0.2);
        }

        .lyric-line:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding-left: 15px;
        }

        @media (max-width: 768px) {
            .lyric-line { font-size: 1.8rem; padding: 12px 0; }
            #lyrics-close { top: 20px; right: 20px; width: 40px; height: 40px; }
            .lyrics-container { padding: 10vh 24px 120px 24px; }
        }

        /* Spotify-like Animations */
        @keyframes spotify-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Discord-style Loading Screen */
        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background-color: #00081C;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-icon-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
        }

        .loading-icon {
            width: 100%;
            height: 100%;
            color: var(--accent);
            animation: discord-spin 1.6s cubic-bezier(0.86, 0, 0.07, 1) infinite;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 10px var(--accent-glow));
        }

        .loading-icon.ghost {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            opacity: 0.3;
            filter: blur(1px);
        }

        .loading-icon.ghost-1 {
            opacity: 0.2;
            animation-delay: -0.1s;
        }

        .loading-icon.ghost-2 {
            opacity: 0.1;
            animation-delay: -0.2s;
        }

        @keyframes discord-spin {
            0% { transform: rotate(0deg); }
            60% { transform: rotate(360deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-tips-container {
            text-align: center;
            max-width: 80%;
            padding: 0 20px;
        }

        .loading-tip-title {
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .loading-tip-text {
            color: #94a3b8;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .loading-icon-wrapper {
                width: 64px;
                height: 64px;
            }
            .loading-tip-text {
                font-size: 14px;
            }
        }

        .animate-spotify {
            animation: spotify-fade-in 0.6s cubic-bezier(0.3, 0, 0, 1) forwards;
        }

        /* Smooth page transitions */
        #homeView, #searchView, #trendingView {
            transition: opacity 0.4s cubic-bezier(0.3, 0, 0, 1), transform 0.4s cubic-bezier(0.3, 0, 0, 1);
        }

        .view-hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute;
        }

        /* Custom scrollbar for the whole app */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid transparent;
            background-clip: padding-box;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid transparent;
            background-clip: padding-box;
        }

        #lyrics-close {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 2001;
        }

        #lyrics-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="selection:bg-blue-500/30">
    <!-- Discord-style Loading Screen -->
    <div id="loading-screen">
        <div class="loading-icon-wrapper">
            <!-- Ghost Shadow 1 -->
            <svg class="loading-icon ghost ghost-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <!-- Ghost Shadow 2 -->
            <svg class="loading-icon ghost ghost-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <!-- Main Icon -->
            <svg class="loading-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
        </div>
        <div class="loading-tips-container">
            <h4 class="loading-tip-title">Did you know?</h4>
            <p id="loading-tip-text" class="loading-tip-text">Loading fresh beats just for you...</p>
        </div>
    </div>
    <!-- AUTHENTICATION LAYER -->
    <div id="auth-overlay">
        <div class="w-full max-w-md p-8 animate-fade-in">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-blue-600 mb-6 shadow-2xl shadow-blue-500/20">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight mb-2">JaMusic <span class="text-blue-500">v2</span></h1>
                <p class="text-slate-400 font-medium">Experience sound in high definition.</p>
            </div>

            <div class="flex justify-center gap-8 mb-8 text-slate-500 font-bold border-b border-white/10 pb-2">
                <button onclick="toggleAuthMode('login')" id="login-tab" class="tab-btn active">Login</button>
                <button onclick="toggleAuthMode('signup')" id="signup-tab" class="tab-btn">Sign Up</button>
            </div>

            <div id="auth-form" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-widest text-slate-500 font-bold px-2">Email Address</label>
                    <input type="email" id="auth-email" placeholder="name@example.com" class="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-6 focus:outline-none focus:border-blue-500/50 transition-all text-white">
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-widest text-slate-500 font-bold px-2">Password</label>
                    <input type="password" id="auth-pass" placeholder="••••••••" class="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-6 focus:outline-none focus:border-blue-500/50 transition-all text-white">
                </div>

                <div class="flex items-center gap-3 px-2 py-2">
                    <input type="checkbox" id="remember-me" checked class="w-4 h-4 rounded bg-white/5 border-white/10 text-blue-500 focus:ring-0">
                    <label for="remember-me" class="text-sm text-slate-400 cursor-pointer">Remember Me (Auto-login)</label>
                </div>

                <button onclick="handleAuth()" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/20 transition-all active:scale-95 cursor-pointer relative">
                    Sign In
                </button>
                <p class="text-center text-[10px] text-slate-600 uppercase tracking-widest mt-4">Safe & Secure Native Environment</p>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-app" class="hidden-state transition-all duration-700">
        
        <!-- SIDEBAR -->
        <aside class="fixed top-0 left-0 h-full w-[280px] glass hidden lg:flex flex-col z-50">
            <div class="p-8 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-12">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-600/30">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    </div>
                    <span class="text-xl font-bold tracking-tighter">JaMusic</span>
                </div>

                <nav class="space-y-1 flex-1">
                    <button onclick="switchView('home')" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl nav-active font-semibold transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        Discover
                    </button>
                    <button onclick="switchView('trending')" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 font-semibold transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        Trending
                    </button>
                </nav>

                <button onclick="logout()" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-red-400 hover:bg-red-500/10 font-semibold transition-all mt-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="lg:ml-[280px] min-h-screen p-6 lg:p-12 pb-48">
            <header class="flex items-center justify-between gap-6 mb-16 relative">
                <div class="relative w-full max-w-xl group">
                    <input type="text" id="searchInput" onkeyup="handleSearch(event)" onfocus="updateSearchSuggestions()" placeholder="Search native library..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 focus:outline-none focus:border-blue-500/50 transition-all text-white">
                    
                    <!-- Search History Suggestions -->
                    <div id="searchSuggestions" class="absolute top-full left-0 right-0 mt-2 glass rounded-2xl overflow-hidden z-[100] border border-white/10 hidden">
                        <!-- Suggestions will be injected here -->
                    </div>
                </div>

                <!-- Account Icon & Dropdown -->
                <div class="relative flex items-center gap-4">
                    <div class="relative">
                        <button onclick="toggleProfileMenu()" id="profile-trigger" class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition-all text-slate-300 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="profile-dropdown" class="profile-dropdown absolute right-0 mt-4 w-64 glass rounded-[1.5rem] p-4 shadow-2xl z-[60]">
                            <div class="pb-4 mb-4 border-b border-white/10">
                                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-black mb-1">Signed in as</p>
                                <p id="dropdown-name" class="font-bold text-white truncate">Username</p>
                                <p id="dropdown-email" class="text-xs text-slate-400 truncate">email@example.com</p>
                            </div>
                            <div class="space-y-1">
                                <button id="display-name-btn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white text-sm transition-all">
                                    <svg class="w-4 h-4 text-slate-500 group-hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Display name
                                </button>

                                <button id="account-settings-btn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white text-sm transition-all group">
                                    <svg class="w-4 h-4 text-slate-500 group-hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    Account Settings
                                </button>

                                <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-500/10 text-red-400 text-sm transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    Log Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <section class="mb-16">
                <div class="relative rounded-[2.5rem] overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/90 via-blue-900/40 to-transparent z-10"></div>
                    <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?auto=format&fit=crop&q=80&w=2000" class="w-full h-[300px] object-cover" alt="Banner">
                    <div class="absolute inset-0 z-20 p-12 flex flex-col justify-center">
                        <h2 class="text-5xl font-black mb-2">Welcome Back, <span id="user-display" class="text-blue-400">User</span></h2>
                        <p class="text-slate-300 mb-6">Your personalized native playlist is ready.</p>
                        <button onclick="playTrack(0)" class="px-8 py-4 bg-white text-black rounded-2xl font-black w-fit hover:bg-blue-400 transition-all active:scale-95 shadow-2xl relative z-30">
                            Play Daily Mix
                        </button>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-3xl font-extrabold mb-10" id="gridTitle">Recommended</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6" id="musicGrid">
                    <!-- Tracks render here -->
                </div>
            </section>
        </main>
    </div>

    <!-- MOBILE APP INTERFACE -->
    <div id="mobile-app" class="hidden-state transition-all duration-700 md:hidden" style="display:none;">
        <div class="min-h-screen pb-32">
             <!-- Mobile Header -->
             <header class="p-6 flex items-center justify-between sticky top-0 z-40 glass border-b border-white/5 relative">
                 <div class="flex items-center gap-3">
                     <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/30">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                     </div>
                     <span class="text-lg font-bold tracking-tighter">JaMusic</span>
                 </div>
                 <button id="mobile-profile-trigger" onclick="toggleProfileMenu()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center transition-all active:scale-95">
                     <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                 </button>

                 <!-- Mobile Dropdown -->
                <div id="mobile-profile-dropdown" class="profile-dropdown absolute right-4 top-20 w-64 glass rounded-[1.5rem] p-4 shadow-2xl z-[60]">
                   <div class="pb-4 mb-4 border-b border-white/10">
                       <p class="text-[10px] uppercase tracking-widest text-slate-500 font-black mb-1">Signed in as</p>
                       <p id="mobile-dropdown-name" class="font-bold text-white truncate">Username</p>
                       <p id="mobile-dropdown-email" class="text-xs text-slate-400 truncate">email@example.com</p>
                   </div>
                   <div class="space-y-1">
                       <button type="button" onclick="document.getElementById('account-settings-btn').click()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white text-sm transition-all">
                           <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                           Account Settings
                       </button>

                       <button type="button" onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-500/10 text-red-400 text-sm transition-all">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                           Log Out
                       </button>
                   </div>
                </div>
             </header>

             <!-- Mobile Content -->
             <div class="p-6 space-y-8">
                 <!-- Search Bar Mobile (Integrated) -->
                 <div id="mobileSearchContainer" class="relative group">
                     <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                         <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                     </div>
                     <input type="text" id="mobileSearchInput" onkeyup="handleSearch(event)" placeholder="Search for songs or artists..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 pl-12 pr-6 focus:outline-none focus:border-blue-500/50 transition-all text-white text-sm">
                 </div>

                 <!-- Welcome Banner Mobile -->
                 <div id="mobileWelcomeBanner" class="relative rounded-[2rem] overflow-hidden group h-[180px] shadow-2xl">
                     <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?auto=format&fit=crop&q=80&w=800" class="absolute inset-0 w-full h-full object-cover">
                     <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent p-6 flex flex-col justify-end">
                         <h2 class="text-2xl font-black mb-1 text-white">Welcome Back</h2>
                         <p class="text-sm text-blue-300 font-medium">Your daily mix is ready.</p>
                     </div>
                 </div>

                 <!-- Mobile Track List -->
                 <section>
                     <h3 class="text-xl font-bold mb-5 flex items-center gap-2">
                        <span class="w-1 h-6 bg-blue-500 rounded-full"></span>
                        Recommended
                     </h3>
                     <div id="mobileMusicList" class="space-y-4">
                         <!-- Tracks render here -->
                     </div>
                 </section>
             </div>
        </div>
        
        <!-- Mobile Bottom Nav -->
        <div class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-2 flex justify-around items-center z-[90] pb-safe">
             <button onclick="switchView('home')" class="flex flex-col items-center gap-1 p-2 rounded-xl text-blue-400">
                 <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                 <span class="text-[10px] font-bold">Home</span>
             </button>
             <button onclick="switchView('search')" class="flex flex-col items-center gap-1 p-2 rounded-xl text-slate-500 hover:text-slate-300">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                 <span class="text-[10px] font-bold">Search</span>
             </button>
             <button onclick="switchView('trending')" class="flex flex-col items-center gap-1 p-2 rounded-xl text-slate-500 hover:text-slate-300">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                 <span class="text-[10px] font-bold">Trending</span>
             </button>
        </div>
    </div>

    <!-- PLAYER BAR -->
    <div id="player-bar" class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 px-4 py-3 lg:px-6 lg:py-4 z-[2100] transform translate-y-full transition-transform duration-500 ease-[cubic-bezier(0.3,0,0,1)]">
        <div class="max-w-[1800px] mx-auto grid grid-cols-3 items-center gap-4">
            
            <!-- Info (Left) -->
            <div class="flex items-center gap-4 min-w-0">
                <div class="relative group">
                    <img id="player-img" src="" class="w-14 h-14 rounded-md object-cover shadow-2xl transition-transform duration-300 group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity rounded-md flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                    </div>
                </div>
                <div class="min-w-0">
                    <h4 id="player-title" class="font-bold text-sm truncate text-white hover:underline cursor-pointer">Song Title</h4>
                    <p id="player-artist" class="text-xs text-slate-400 truncate hover:text-white transition-colors cursor-pointer">Artist Name</p>
                </div>
                <button class="text-slate-400 hover:text-[#1db954] transition-colors ml-2 hidden sm:block">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </button>
            </div>

            <!-- Controls (Middle) -->
            <div class="flex flex-col items-center gap-1.5 w-full">
                <div class="flex items-center gap-4 lg:gap-8">
                    <button class="text-slate-400 hover:text-white transition-colors hidden sm:block" title="Shuffle">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.45 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                    </button>

                    <button class="text-slate-400 hover:text-white transition-colors active:scale-90" onclick="prevTrack()" title="Previous">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>

                    <button id="play-pause-btn" onclick="togglePlay()" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-xl">
                        <svg id="play-icon" class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>

                    <button class="text-slate-400 hover:text-white transition-colors active:scale-90" onclick="nextTrack()" title="Next">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>

                    <button id="repeat-btn" onclick="toggleRepeat()" title="Repeat" class="text-slate-400 hover:text-white transition-colors hidden sm:block">
                        <svg id="repeat-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M7 7v4h10V7l4 4-4 4v-4H5V7z"></path></svg>
                    </button>
                </div>
                <div class="flex items-center gap-2 w-full max-w-[600px]">
                    <span id="curr-time" class="text-[11px] text-slate-500 w-10 text-right font-medium">0:00</span>
                    <div class="group relative flex-1 h-1 flex items-center">
                        <div class="absolute inset-0 bg-white/10 rounded-full"></div>
                        <div id="progress-bar-fill" class="absolute h-full bg-white group-hover:bg-[#1db954] rounded-full transition-colors" style="width: 0%"></div>
                        <input type="range" id="seek-slider" value="0" step="1" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div id="seek-thumb" class="absolute w-3 h-3 bg-white rounded-full opacity-0 group-hover:opacity-100 shadow-lg -translate-x-1/2 left-[0%] transition-opacity"></div>
                    </div>
                    <span id="dur-time" class="text-[11px] text-slate-500 w-10 font-medium">0:00</span>
                </div>
            </div>

            <!-- Extras (Right) -->
            <div class="flex items-center justify-end gap-3 lg:gap-5 min-w-0">
                <button id="lyrics-btn" onclick="toggleLyrics()" title="Lyrics" class="text-slate-400 hover:text-[#1db954] transition-colors p-1 rounded-full hover:bg-white/5">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                </button>
                
                <div id="volume-slider-container" class="hidden md:flex items-center gap-2 group w-32">
                    <button class="text-slate-400 hover:text-white transition-colors" id="mute-btn">
                        <svg id="volume-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                    <div class="relative flex-1 h-1 group/vol flex items-center">
                        <div class="absolute inset-0 bg-white/10 rounded-full"></div>
                        <div id="volume-bar-fill" class="absolute h-full bg-white group-hover/vol:bg-[#1db954] rounded-full" style="width: 100%"></div>
                        <input type="range" id="volume-slider" value="100" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" style="touch-action: pan-y;">
                    </div>
                </div>

                <div class="hidden lg:flex items-center gap-1.5 h-6">
                    <div class="visualizer-bar w-0.5 bg-[#1db954]/40 rounded-full" style="height: 20%"></div>
                    <div class="visualizer-bar w-0.5 bg-[#1db954]/60 rounded-full" style="height: 60%"></div>
                    <div class="visualizer-bar w-0.5 bg-[#1db954] rounded-full" style="height: 40%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS OVERLAY + SIDEBAR -->
    <div id="settings-overlay"></div>

    <div id="settings-sidebar" class="glass p-6 rounded-l-2xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Account Settings</h2>
            <button id="settings-close" class="text-white text-2xl leading-none">&times;</button>
        </div>

        <div class="flex gap-3 mb-4">
            <button id="tab-general" class="tab-btn active">General</button>
            <button id="tab-zoom" class="tab-btn">Zoom</button>
        </div>

        <div id="settings-content" class="flex-1 overflow-y-auto">
            <div id="settings-general">
                <p class="font-semibold text-sm text-slate-400 mb-2">Volume</p>
                <input type="range" id="settings-volume" value="100" class="w-full touch-action-manipulation" style="touch-action: pan-y;">

                <p class="font-semibold text-sm text-slate-400 mt-4 mb-2">Theme</p>
                <div class="flex gap-4">
                    <button id="theme-light-btn" class="px-4 py-2 bg-white text-black rounded-xl">Light</button>
                    <button id="theme-dark-btn" class="px-4 py-2 bg-black text-white rounded-xl">Dark</button>
                </div>
            </div>

            <div id="settings-zoom" class="hidden">
                <p class="font-semibold text-sm text-slate-400 mb-2">Page Zoom</p>
                <input type="range" id="settings-zoom-slider" min="0.6" max="1.4" step="0.05" value="1" class="w-full">
                <p class="text-xs text-slate-500 mt-2">Adjust the page scale for readability on mobile or desktop.</p>
            </div>
        </div>
    </div>

    <!-- DISPLAY NAME MODAL -->
    <div id="displayname-overlay" aria-hidden="true">
        <div id="displayname-modal" class="displayname-modal" role="dialog" aria-modal="true">
            <!-- WARNING VIEW -->
            <div id="dn-warning-view">
                <h3 class="text-lg font-bold mb-2">Hmm...</h3>
                <p class="text-slate-300">It looks like you're using an email as your display name. That could lead to possible vulnerabilities (phishing, accidental exposure). Do you want to change it?</p>
                <div class="dn-actions">
                    <button id="dn-no" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10">No</button>
                    <button id="dn-yes" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-white">Yes</button>
                </div>
            </div>

            <!-- INPUT VIEW -->
            <div id="dn-input-view" style="display:none;">
                <h3 class="text-lg font-bold mb-2">Choose a display name</h3>
                <p class="text-slate-400 text-sm mb-4">No special characters allowed. Use letters, numbers, spaces, underscores or hyphens.</p>
                <input type="text" id="dn-input" class="dn-input" placeholder="Put your display name here" maxlength="30" />
                <div id="dn-error" class="dn-error" style="display:none;">Invalid characters detected. Try letters, numbers, spaces, underscores or hyphens only.</div>

                <div class="dn-actions">
                    <button id="dn-cancel" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10">Cancel</button>
                    <button id="dn-submit" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-white">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LYRICS OVERLAY -->
    <div id="lyrics-overlay" role="dialog" aria-labelledby="lyrics-title">
        <div id="lyrics-close" onclick="toggleLyrics()" aria-label="Close lyrics" role="button" tabindex="0" onkeydown="if(event.key==='Enter') toggleLyrics()">&times;</div>
        
        <div class="lyrics-container" id="lyrics-container">
            <h2 id="lyrics-title" class="sr-only">Full Lyrics</h2>
            <div id="lyrics-content">
                <!-- Lyrics will be injected here -->
                <div class="text-center py-20">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-6"></div>
                    <p class="text-slate-400 font-bold text-xl">Loading lyrics...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /***********************
         * Loading Screen Logic
         ***********************/
        (function() {
            const tips = [
                "You can toggle lyrics by clicking the microphone icon!",
                "Try searching for 'offline' to see how the app handles network issues.",
                "JaMusic v2 is optimized for both desktop and mobile devices.",
                "Double-tap a song to start playing it instantly.",
                "Your search history is saved locally for quick access.",
                "The visualizer reacts to the rhythm of the music.",
                "Did you know? You can change your display name in account settings.",
                "Hover over a song card to see the quick-play button!",
                "Keep the beats going by enabling the repeat mode in the player."
            ];

            const tipTextEl = document.getElementById('loading-tip-text');
            const loadingScreen = document.getElementById('loading-screen');
            
            if (tipTextEl) {
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                tipTextEl.innerText = randomTip;
            }

            // Show for 3 seconds, then fade out
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                        // Optional: Remove from DOM after transition
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }
                }, 3000);
            });
        })();

        /********************************************************************
         * Full single-file app:
         * - keeps your original UI & scripts
         * - adds repeat (loop) track toggle
         ********************************************************************/

        /* -------------------------
           Core player + app variables
        ------------------------- */
        const audio = new Audio();
        // PASTE YOUR GENIUS TOKEN BELOW
        const HARDCODED_GENIUS_TOKEN = ''; 

        let currentTrackIndex = 0;
        let isPlaying = false;
        let authMode = 'login';
        let repeatTracks = false; 
        let currentView = 'home'; // 'home', 'search', 'trending'
        let searchTimeout = null;
        let currentLyrics = [];
        let lyricsVisible = false;

        /***********************
         * Track Data
         ***********************/
        const tracks = [
            { 
                id: '1', 
                title: 'Never Gonna Give You Up', 
                artist: 'Rick Astley', 
                img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTPCuAC8hFa8nHMv1kf61oWZXQVLXLDhEuW1g&s', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Rick%20Astley%20-%20Never%20Gonna%20Give%20You%20Up%20(Official%20Video)%20(4K%20Remaster).mp3',
                lyrics: `[Intro]
(Ooh, ooh)
(Ooh, ooh)

[Verse 1]
We're no strangers to love
You know the rules and so do I (do I)
A full commitment's what I'm thinking of
You wouldn't get this from any other guy

[Pre-Chorus]
I just wanna tell you how I'm feeling
Gotta make you understand

[Chorus]
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you

[Verse 2]
We've known each other for so long
Your heart's been aching, but you're too shy to say it (to say it)
Inside, we both know what's been going on (going on)
We know the game and we're gonna play it

[Pre-Chorus]
And if you ask me how I'm feeling
Don't tell me you're too blind to see

[Chorus]
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you

[Bridge]
(Ooh, give you up)
(Ooh, give you up)
(Ooh) Never gonna give, never gonna give (give you up)
(Ooh) Never gonna give, never gonna give (give you up)

[Verse 3]
We've known each other for so long
Your heart's been aching, but you're too shy to say it (to say it)
Inside, we both know what's been going on (going on)
We know the game and we're gonna play it

[Pre-Chorus]
I just wanna tell you how I'm feeling
Gotta make you understand

[Chorus]
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you
Never gonna give you up
Never gonna let you down
Never gonna run around and desert you
Never gonna make you cry
Never gonna say goodbye
Never gonna tell a lie and hurt you`
            },
            { 
                id: '2', 
                title: 'End of Beginning', 
                artist: 'Djo', 
                img: 'https://images.genius.com/00875ec415993c9cf0e554666bf16b45.1000x1000x1.png', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Djo%20-%20End%20Of%20Beginning%20(Official%20Audio).mp3',
                lyrics: `[Verse 1]
Just one more tear to cry, one teardrop from my eye
You better save it for
The middle of the night when things aren't black and white
Enter, Troubadour
"Remember twenty-four?"

[Chorus]
And when I'm back in Chicago, I feel it
Another version of me, I was in it
I wave goodbye to the end of beginning

[Verse 2]
This song has started now, and you're just finding out
Now isn't that a laugh?
A major sacrifice, but clueless at the time
Enter, Caroline
"Just trust me, you'll be fine"

[Chorus]
And when I'm back in Chicago, I feel it
Another version of me, I was in it
I wave goodbye to the end of beginning
(Goodbye, goodbye, goodbye, goodbye)

[Bridge]
You take the man out of the city, not the city out the man
You take the man out of the city, not the city out the man
You take the man out of the city, not the city out the man
You take the man out of the—

[Chorus]
And when I'm back in Chicago, I feel it
Another version of me, I was in it
Oh, I wave goodbye to the end of beginning
(Goodbye, goodbye)`
            },
            { 
                id: '3', 
                title: 'Heat Waves', 
                artist: 'Glass Animals', 
                img: 'https://i.scdn.co/image/ab67616d0000b2739e495fb707973f3390850eea', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Glass%20Animals%20-%20Heat%20Waves%20(Lyrics).mp3',
                lyrics: `[Intro]
(Last night, all I think about is you)
(Don't stop, baby, you can walk through)
(Don't want, baby, think about you)
(You know that I'm never gonna lose)
Road shimmer wigglin' the vision
Heat, heat waves, I'm swimmin' in a mirror
Road shimmer wigglin' the vision
Heat, heat waves, I'm swimmin' in a—

[Chorus]
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now

[Verse 1]
Usually, I put somethin' on TV
So we never think about you and me
But today, I see our reflections clearly
In Hollywood, layin' on the screen
You just need a better life than this
You need somethin' I can never give
Fake water all across the road
It's gone now, the night has come, but

[Chorus]
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now

[Verse 2]
You can't fight it, you can't breathe
You say somethin' so lovin', but
Now I gotta let you go
You'll be better off in someone new
I don't wanna be alone
You know it hurts me too
You look so broken when you cry
One more and then I say goodbye

[Chorus]
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now

[Bridge]
I just wonder what you're dreamin' of
When you sleep and smile so comfortable
I just wish that I could give you that
That look that's perfectly un-sad
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Heat waves been fakin' me out

[Chorus]
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now
Sometimes, all I think about is you
Late nights in the middle of June
Heat waves been fakin' me out
Can't make you happier now

[Outro]
Road shimmer wigglin' the vision
Heat, heat waves, I'm swimmin' in a mirror
Road shimmer wigglin' the vision
Heat, heat waves, I'm swimmin' in a mirror`
            },
            { 
                id: '4', 
                title: 'Stereo Hearts', 
                artist: 'Gym Class Heroes', 
                img: 'https://i.scdn.co/image/ab67616d0000b273706dcf46953a040b8ed4b333', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Gym%20Class%20Heroes%20-%20Stereo%20Hearts%20(Lyrics)%20%20Heart%20Stereo.mp3',
                lyrics: `[Chorus: Adam Levine & Travie McCoy]
My heart's a stereo
It beats for you, so listen close
Hear my thoughts in every no—
Oh—ote
Make me your radio (Yeah, ha)
And turn me up when you feel low (Turn it up a little bit)
This melody was meant for you (Right there)
To sing along to my stereo (Gym Class Heroes, baby!)

[Verse 1: Travie McCoy]
If I was just another dusty record on the shelf
Would you blow me off and play me like everybody else?
If I asked you to scratch my back, could you manage that?
Like yikky-yeah check it, Travie, I can handle that
Furthermore, I apologize for any skipping tracks
It's just the last girl that played me left a couple cracks
I used to, used to, used to, used to, now I'm over that
'Cause holding grudges over love is ancient artifacts

[Pre-Chorus 1: Travie McCoy]
If I could only find a note to make you understand
I’d sing it softly in your ear and grab you by the hand
Just keep me stuck inside your head like your favorite tune
And know my heart's a stereo that only plays for you (Uh-ha-ha)

[Chorus: Adam Levine & Travie McCoy]
My heart's a stereo
It beats for you, so listen close
Hear my thoughts in every no— (Yeah)
Oh—ote (Yeah, yeah, come on)
Make me your radio (Huh-uh)
And turn me up when you feel low (Turn it up)
This melody was meant for you
To sing along to my stereo

[Post-Chorus: Adam Levine & Travie McCoy]
Oh, oh oh-oh, oh
Oh oh-oh (To my stereo)
Oh, oh-oh, oh
To sing along to my stereo
Let's go!

[Verse 2: Travie McCoy]
If I was an old-school, fifty-pound boombox (Remember them?)
Would you hold me on your shoulder wherever you walk?
Would you turn my volume up in front of the cops? (Turn it up)
And crank it higher every time they told you to stop (Peace)
And all I ask is that you don't get mad at me
When you have to purchase mad D batteries
Appreciate every mixtape your friends make
You never know, we come and go like on the interstate (Never know)

[Pre-Chorus 2: Travie McCoy]
I think I finally found a note to make you understand
If you could hit it, sing along and take me by the hand
Just keep me stuck inside your head, like your favorite tune
You know my heart's a stereo that only plays for you (Uh-ha-ha)

[Chorus: Adam Levine & Travie McCoy]
My heart's a stereo (Yeah)
It beats for you, so listen close (Listen)
Hear my thoughts in every no—
Oh—ote (Oh, oh)
Make me your radio (Come on)
And turn me up when you feel low (Turn it up)
This melody was meant for you
To sing along to my stereo (Sing along like)

[Post-Chorus: Adam Levine & Travie McCoy]
Oh, oh oh-oh, oh (Yeah)
Oh oh-oh (To my stereo)
Oh, oh-oh, oh
To sing along to my stereo (Sing along, sing along)

[Bridge: Adam Levine & Travie McCoy]
I only pray you never leave me behind (Never leave me)
Because good music can be so hard to find (So hard to find)
I'll take your hand and hold it closer to mine (Yeah)
Thought love was dead, but now you're changing my mind (Yeah, yeah, come on, ooh)

[Chorus: Adam Levine]
My heart's a stereo (Yeah)
It beats for you, so listen close
Hear my thoughts in every no—
Oh—ote (Oh, oh, oh)
Make me your radio (Huh-uh)
And turn me up when you feel low (Turn it up)
This melody was meant for you
To sing along to my stereo

[Outro: Adam Levine & Travie McCoy]
Oh, oh oh-oh, oh (Ha-ha)
Yeah, yeah, ye—eh—eh
Oh oh oh-oh (To my stereo)
Yeah, yeah, ye—eh—eh
Oh, oh-oh (It's your boy, Travie)
Yeah, yeah, ye—eh—eh
(Gym Class Heroes, baby) To sing along to my stereo
Yeah, yeah, yeah
Yeah`
            },
            { 
                id: '5', 
                title: 'Get Lucky', 
                artist: 'Daft Punk', 
                img: 'https://images-ext-1.discordapp.net/external/xR3pl2SlUtADo9357RJ1lvKlsgnie7faJtruZyDKNu8/%3Fcb%3D20140421225330%26path-prefix%3Des/https/static.wikia.nocookie.net/daftpunk/images/7/71/Get_Lucky.jpg/revision/latest?format=png', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Daft%20Punk%20-%20Get%20Lucky%20(Lyrics)%20ft.%20Pharrell%20Williams,%20Nile%20Rodgers.mp3',
                lyrics: `[Verse 1: Pharrell]
Like the legend of the phoenix
All ends with beginnings
What keeps the planet spinning
The force from the beginning

[Pre-Chorus: Pharrell]
We've come too far
To give up who we are
So let's raise the bar
And our cups to the stars

[Chorus: Pharrell]
She's up all night to the sun, I'm up all night to get some
She's up all night for good fun, I'm up all night to get lucky
We're up all night to the sun, we're up all night to get some
We're up all night for good fun, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky

[Verse 2: Pharrell]
The present has no ribbon
Your gift keeps on giving
What is this I'm feeling?
If you want to leave, I'm with it

[Pre-Chorus: Pharrell]
We've come too far
To give up who we are
So let's raise the bar
And our cups to the stars

[Chorus: Pharrell]
She's up all night to the sun, I'm up all night to get some
She's up all night for good fun, I'm up all night to get lucky
We're up all night to the sun, we're up all night to get some
We're up all night for good fun, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky

[Bridge: Daft Punk]
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky

[Pre-Chorus: Pharrell]
We've come too far
To give up who we are
So let's raise the bar
And our cups to the stars

[Chorus: Pharrell]
She's up all night to the sun, I'm up all night to get some
She's up all night for good fun, I'm up all night to get lucky
We're up all night to the sun, we're up all night to get some
We're up all night for good fun, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky
We're up all night to get lucky, we're up all night to get lucky

[Outro: Pharrell]
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky
We're up all night to get lucky`
            },
            { 
                id: '6', 
                title: 'Rap God', 
                artist: 'Eminem', 
                img: 'https://images-ext-1.discordapp.net/external/5NjINKSPrPYMPecFhmRVSyb_aMQAQTUEB_7EmfB9EME/https/i.scdn.co/image/ab67616d0000b273643e6ecebab400d52574e4b2?format=webp', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Eminem%20-%20Rap%20God%20(Explicit).mp3',
                lyrics: `[Intro]
"Look, I was gonna go easy on you not to hurt your feelings"
"But I'm only going to get this one chance" (Six minutes—, six minutes—)
"Something's wrong, I can feel it" (Six minutes, Slim Shady, you're on!)
"Just a feeling I've got, like something's about to happen, but I don't know what. 
If that means what I think it means, we're in trouble, big trouble; 
And if he is as bananas as you say, I'm not taking any chances"
"You are just what the doc ordered"

[Chorus]
I'm beginnin' to feel like a Rap God, Rap God
All my people from the front to the back nod, back nod
Now, who thinks their arms are long enough to slap box, slap box?
They said I rap like a robot, so call me Rap-bot

[Verse 1]
But for me to rap like a computer it must be in my genes
I got a laptop in my back pocket
My pen'll go off when I half-cock it
Got a fat knot from that rap profit
Made a livin' and a killin' off it
Ever since Bill Clinton was still in office
With Monica Lewinsky feelin' on his nutsack
I'm an MC still as honest
But as rude and as indecent as all hell
Syllables, skill-a-holic (Kill 'em all with)
This flippity dippity-hippity hip-hop
You don't really wanna get into a pissin' match
With this rappity brat, packin' a MAC in the back of the Ac'
Backpack rap crap, yap-yap, yackety-yack
And at the exact same time, I attempt these lyrical acrobat stunts while I'm practicin' that
I'll still be able to break a motherfuckin' table
Over the back of a couple of faggots and crack it in half
Only realized it was ironic, I was signed to Aftermath after the fact
How could I not blow? All I do is drop F-bombs
Feel my wrath of attack
Rappers are havin' a rough time period, here's a maxi pad
It's actually disastrously bad for the wack
While I'm masterfully constructing this masterpièce

[Chorus]
'Cause I'm beginnin' to feel like a Rap God, Rap God
All my people from the front to the back nod, back nod
Now, who thinks their arms are long enough to slap box, slap box?
Let me show you maintainin' this shit ain't that hard, that hard
Everybody want the key and the secret to rap immortality like I have got

[Verse 2]
Well, to be truthful the blueprint's
Simply rage and youthful exuberance
Everybody loves to root for a nuisance
Hit the Earth like an asteroid
Did nothing but shoot for the Moon since (Pew!)
MCs get taken to school with this music
'Cause I use it as a vehicle to "bus the rhyme"
Now I lead a new school full of students
Me? I'm a product of Rakim
Lakim Shabazz, 2Pac, N.W.A, Cube, hey Doc, Ren
Yella, Eazy, thank you, they got Slim
Inspired enough to one day grow up, blow up and be in a position
To meet Run–D.M.C., and induct them
Into the motherfuckin' Rock and Roll Hall of Fame
Even though I'll walk in the church and burst in a ball of flames
Only Hall of Fame I'll be inducted in is the alcohol of fame
On the wall of shame
You fags think it's all a game, 'til I walk a flock of flames
Off a plank and, tell me what in the fuck are you thinkin'?
Little gay-lookin' boy
So gay I can barely say it with a straight face, lookin' boy (Ha-ha!)
You're witnessin' a mass-occur
Like you're watching a church gathering take place, lookin' boy
"Oy vey, that boy's gay!"—that's all they say, lookin' boy
You get a thumbs up, pat on the back
And a "way to go" from your label every day, lookin' boy
Hey, lookin' boy! What you say, lookin' boy?
I get a "hell yeah" from Dre, lookin' boy
I'ma work for everything I have, never asked nobody for shit
Get outta my face, lookin' boy!
Basically, boy, you're never gonna be capable
Of keepin' up with the same pace, lookin' boy, 'cause—

[Chorus]
I'm beginnin' to feel like a Rap God, Rap God
All my people from the front to the back nod, back nod
The way I'm racin' around the track, call me NASCAR, NASCAR
Dale Earnhardt of the trailer park, the White Trash God
Kneel before General Zod
This planet's Krypton—no, Asgard, Asgard

[Verse 3]
So you'll be Thor and I'll be Odin
You rodent, I'm omnipotent
Let off, then I'm reloadin'
Immediately with these bombs I'm totin'
And I should not be woken
I'm the walkin' dead, but I'm just a talkin' head, a zombie floatin'
But I got your mom deep-throatin'
I'm out my Ramen Noodle
We have nothin' in common, poodle
I'm a Doberman, pinch yourself in the arm and pay homage, pupil
It's me, my honesty's brutal
But it's honestly futile if I don't utilize what I do though
For good at least once in a while
So I wanna make sure somewhere in this chicken scratch I scribble and doodle enough rhymes
To maybe try to help get some people through tough times
But I gotta keep a few punchlines
Just in case 'cause even you unsigned
Rappers are hungry lookin' at me like it's lunchtime
I know there was a time where once I
Was king of the underground
But I still rap like I'm on my Pharoahe Monch grind
So I crunch rhymes, but sometimes when you combine
Appeal with the skin color of mine
You get too big and here they come tryin'
To censor you like that one line
I said on "I'm Back" from The Mathers LP 1 when I
Tried to say I'll take seven kids from Columbine
Put 'em all in a line, add an AK-47, a revolver and a 9
See if I get away with it now that I ain't as big as I was, but I'm
Morphin' into an immortal, comin' through the portal
You're stuck in a time warp from 2004 though
And I don't know what the fuck that you rhyme for
You're pointless as Rapunzel with fuckin' cornrows
You write normal? Fuck being normal!
And I just bought a new raygun from the future
Just to come and shoot ya, like when Fabolous made Ray J mad
'Cause Fab said he looked like a fag at Mayweather's pad
Singin' to a man while he played piano
Man, oh man, that was a 24/7 special on the cable channel
So Ray J went straight to the radio station
The very next day, "Hey Fab, I'ma kill you!"
Lyrics comin' at you at supersonic speed (J.J. Fad)
Uh, summa-lumma, dooma-lumma, you assumin' I'm a human
What I gotta do to get it through to you? I'm superhuman
Innovative and I'm made of rubber so that anything you say is ricochetin' off of me and it'll glue to you and
I'm devastating, more than ever demonstrating
How to give a motherfuckin' audience a feeling like it's levitating
Never fading, and I know the haters are forever waiting
For the day that they can say I fell off, they'll be celebrating
'Cause I know the way to get 'em motivated
I make elevating music, you make elevator music
"Oh, he's too mainstream."
Well, that's what they do when they get jealous, they confuse it
"It's not hip-hop, it's pop,"—'cause I found a hella way to fuse it
With rock, shock rap with Doc
Throw on "Lose Yourself" and make 'em lose it
"I don't know how to make songs like that
I don't know what words to use."
Let me know when it occurs to you
While I'm rippin' any one of these verses that versus you
It's curtains, I'm inadvertently hurtin' you
How many verses I gotta murder to
Prove that if you were half as nice, your songs you could sacrifice virgins too?!
Ugh, school flunky, pill junkie
But look at the accolades these skills brung me
Full of myself, but still hungry
I bully myself 'cause I make me do what I put my mind to
And I'm a million leagues above you
Ill when I speak in tongues, but it's still tongue-in-cheek, fuck you
I'm drunk, so, Satan, take the fucking wheel
I'ma sleep in the front seat
Bumpin' Heavy D and the Boyz, still "Chunky but Funky"
But in my head there's something I can feel tugging and struggling
Angels fight with devils and here's what they want from me
They're askin' me to eliminate some of the women hate
But if you take into consideration the bitter hatred
I have, then you may be a little patient
And more sympathetic to the situation
And understand the discrimination
But fuck it, life's handin' you lemons? Make lemonade then!
But if I can't batter the women
How the fuck am I supposed to bake 'em a cake then?
Don't mistake him for Satan
It's a fatal mistake if you think I need to be overseas and take a vacation
To trip a broad, and make her fall on her face and
Don't be a retard—be a king? Think not
Why be a king when you can be a god?`
            },
            { 
                id: '7', 
                title: 'A LITTLE THEORIZING', 
                artist: 'Stupendium', 
                img: 'https://i.scdn.co/image/ab67616d0000b273bfebcc991d99e277f3260221', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/A%20Little%20Theorizing%20Lyrics.mp3',
                lyrics: `[Verse 1]
Boot up your computer, stick a disk in your console's drive
Whatever platform you're choosing, it's time to switch on your mind
Could be Super Mario, shooters, FNaF or those evenings down in the mines
But if you look past all those shiny graphics you'll be surprised what you'll find
Inside these worlds we love, behind our TV screens
There's so much to discover when you peek between
The tiny gaps in the story, science, math and the lore
We've got all that to explore, plus there's some decent memes
How hard does a headshot blow? How fast does a hedgehog go?
Frogger might not last in biology class
But have you tried to dissect a Toad?
How creepers get to explode? The secrets buried in code?
You'll never guess what happened to the guests that were left in that restaurant though

[Chorus]
In every level you beat and each boss battle defeat
With each achievement, your view becomes a bit more complete
And with each twist that unfolds and every mystery you solve
We find a new way to see this ball on which we revolve
These games have secrets inside and
As a team, we can find them
You've a blank page and a clear horizon
So why not do a little theorizing?
I think it's time we did a little theorizing

[Verse 2]
It's a whole lotta' research and the clues keep piling up
But you're not a ScottGames teaser, you're already bright enough
So sit back and grab a diet coke or a can full of human souls
And ask if you might survive the jump, chucking nuggets into the hole
Build a city in the sky and you might vomit from the motion
So you think to try it at the bottom of the ocean
Get the physics right or glass will probably be broken
Then it's still more likely than the FNaF box ever opening
Carrion flesh, Marionettes
Keeping companions fed
How old Ash Ketchum gets
And we all know that Sans is Ness
Never had I thought of Markiplier getting freaky
With a Pokémon made by combining other species
Volcanic pressure washing coughing, dogs inside the TV
The horror that is Monika and finding she could see me
The secret of the bottle flip, the Ender Dragon obelisks
Just why is Zipper's body zipped? A million other theories
You may gain a wealth of knowledge
But you aren't as rich as Luigi

[Chorus]
In every level you beat and each boss battle defeat
With each achievement your view becomes a bit more complete
And with each twist that unfolds and every mystery you solve
We find a new way to see this ball on which we revolve
These games have secrets inside and
As a team we can find them
You've a blank page and a clear horizon
So why not do a little theorizing?
I think it's time we did a little theorizing

[Synth Solo]

[Verse 3]
But we're not contained to video games, there's loads to explore
Will you or the food expire first, locked in a grocery store?
When navigating a labyrinth, how will you locate the door?
And five pro-strats for surviving traps if you were chosen in Saw
The cannibalism practiced on the Axiom Starship
The dragonfly mechanics of some animate cars
Impractical dynamics of a family of sharks
Or the best hamburger tactics when you're stacking the parts
If everyone together does a clap and a half
We add the decibels we measure then map that on a graph
You'd see we don't need professors here for cracking the answers
It's clever but never forget, we're having a laugh
And we'll do a lot of learning on the way
The gears are always churning so just turn another page
Whoever said that work should be impervious to play
Never learned to peek behind the curtain of the games
A curious community is spinning the globe
You could join us too, but it's a slippery slope
I'm addicted, so I think I'll pick theories we wrote
Then I'll wrap them with a bow and give it to the Pope

[Chorus]
In every level you beat and each boss battle defeat
With each achievement your view becomes a bit more complete
And with each twist that unfolds and every mystery you solve
We find a new way to see this ball on which we revolve
These games have secrets inside and
As a team, we can find them
You've a blank page and a clear horizon
So why not do a little theorizing?
(But that's just a theory, a game theory)
I think it's time we did a little theorizing
(But that's just a theory, a game theory)

[Post-Chorus]
A little theorizing
(But that's just a theory, a game theory)
A little theorizing
(But that's just a theory, a game theory)
(But that's just a theory, a game theory)
(There's theories all around you)
(But that's just a theory, a game theory)
(The answers might astound you)
(But that's just a theory, a game theory)
I think it's time we did a little theorizing

[Outro]
But that's just a theory, a game theory
Thanks for watching`
            },
            { 
                id: '8', 
                title: 'Corrupted', 
                artist: 'Danimal Cannon', 
                img: 'https://i.scdn.co/image/ab67616d0000b27339be440fe5b4ef67f9de6cc7', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/Danimal%20Cannon%20&%20Zef%20-%20Corrupted.mp3',
                lyrics: `[Instrumental]`
            },
            { 
                id: '9', 
                title: 'River Flows In You', 
                artist: 'DJ Herjuana', 
                img: 'https://i.scdn.co/image/ab67616d0000b27371cde6e77fc2d217cbc5f567', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/SpotiDownloader.com%20-%20River%20Flows%20in%20You%20-%20DJ%20HERJUANA.mp3',
                lyrics: `[Instrumental]`
            },
            { 
                id: '10', 
                title: 'FTW', 
                artist: 'Lets be Friends', 
                img: 'https://upload.wikimedia.org/wikipedia/en/5/53/FTW_Lets_Be_Friends_Orignal_Cover.jpeg', 
                src: 'https://github.com/smileyface-istg/JaMusic-v2/raw/refs/heads/main/%5BElectro%5D%20-%20Lets%20Be%20Friends%20-%20FTW%20%5BMonstercat%20Release%5D.mp3',
                lyrics: `[Intro: Sampled]
But I just gotta know, one thing
Are you ready?
No! I said
Are
You
Ready?

[Pre-Drop: Sampled]
Are you ready?
No! I said
Are
You
Ready?

[Drop: Sampled]
Are you ready?
No! I said
Are
You
Ready?`
            }
        ];

        // Track statistics (play counts, last played)
        let trackStats = {};
        
        // GLOBAL SYNC VERSIONING: Clear old local junk to ensure true global data
        const SYNC_VERSION = '2.1';
        if (localStorage.getItem('jamusic_sync_v') !== SYNC_VERSION) {
            localStorage.removeItem('jamusic_stats');
            localStorage.setItem('jamusic_sync_v', SYNC_VERSION);
        }

        try {
            trackStats = JSON.parse(localStorage.getItem('jamusic_stats') || '{}');
        } catch(e) { trackStats = {}; }

        function saveStats() {
            localStorage.setItem('jamusic_stats', JSON.stringify(trackStats));
        }

        function incrementPlayCount(trackId) {
            // Update local immediately for snappy UI
            if (!trackStats[trackId]) {
                trackStats[trackId] = { playCount: 0, lastPlayed: 0, lastListener: '', uniqueListeners: 1 };
            }
            trackStats[trackId].playCount++;
            trackStats[trackId].lastPlayed = Date.now();
            
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const userName = user ? (user.name || user.email.split('@')[0]) : 'Someone';
            const userId = user ? user.email.replace(/[.$#[\]]/g, '_') : 'guest'; // Firebase safe key
            
            trackStats[trackId].lastListener = userName;
            saveStats();

            // Global Sync to Firebase
            try {
                if (window.db && window.dbIncrement && window.dbRefPath && window.dbUpdate) {
                    const trackRef = `global_stats/tracks/${trackId}`;
                    const updates = {};
                    
                    // Increment total plays
                    updates[`${trackRef}/playCount`] = window.dbIncrement(1);
                    updates[`${trackRef}/lastPlayed`] = Date.now();
                    updates[`${trackRef}/lastListener`] = userName;
                    
                    // Track this specific user as a unique listener
                    // We use the userId as a key so it doesn't duplicate
                    updates[`${trackRef}/listeners/${userId}`] = {
                        name: userName,
                        lastPlayed: Date.now()
                    };
                    
                    window.dbUpdate(window.dbRefPath(window.db), updates).catch(e => console.error("Firebase update failed:", e));
                }
            } catch(e) { console.error("Global sync error:", e); }
        }

        let isStatsListenerActive = false;
        function initGlobalStatsListener() {
            if (isStatsListenerActive) return;
            try {
                if (window.db && window.dbOnValue && window.dbRefPath) {
                    const statsRef = window.dbRefPath(window.db, 'global_stats/tracks');
                    window.dbOnValue(statsRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const globalData = snapshot.val();
                            const newStats = {};
                            for (const trackId in globalData) {
                                const data = globalData[trackId];
                                const listeners = data.listeners || {};
                                const uniqueCount = Object.keys(listeners).length;
                                
                                newStats[trackId] = {
                                    playCount: data.playCount || 0,
                                    lastListener: data.lastListener || 'Someone',
                                    lastPlayed: data.lastPlayed || 0,
                                    uniqueListeners: uniqueCount || 1
                                };
                            }
                            trackStats = newStats;
                            saveStats();
                            
                            if (typeof currentView !== 'undefined' && currentView === 'trending') {
                                renderTracks(getTrendingTracks());
                            }
                        }
                    });
                    isStatsListenerActive = true;
                }
            } catch(e) { console.error("Stats listener error:", e); }
        }

        async function fetchGlobalStats() {
            initGlobalStatsListener();
            try {
                if (window.db && window.dbGet && window.dbChild && window.dbRefPath) {
                    const snapshot = await window.dbGet(window.dbRefPath(window.db, 'global_stats/tracks'));
                    if (snapshot.exists()) {
                        const globalData = snapshot.val();
                        const newStats = {};
                        for (const trackId in globalData) {
                            const data = globalData[trackId];
                            const listeners = data.listeners || {};
                            const uniqueCount = Object.keys(listeners).length;

                            newStats[trackId] = {
                                playCount: data.playCount || 0,
                                lastListener: data.lastListener || 'Someone',
                                lastPlayed: data.lastPlayed || 0,
                                uniqueListeners: uniqueCount || 1
                            };
                        }
                        trackStats = newStats;
                        saveStats();
                    }
                }
            } catch(e) { console.error("Fetch global stats error:", e); }
        }

        function getTrendingTracks() {
            return [...tracks].sort((a, b) => {
                const statA = trackStats[a.id] || { playCount: 0 };
                const statB = trackStats[b.id] || { playCount: 0 };
                return statB.playCount - statA.playCount;
            });
        }

        /***********************
         * Storage helpers
         ***********************/
        function getCurrentUser(){
            try { const s = localStorage.getItem('jamusic_user'); return s ? JSON.parse(s) : null; } catch(e){ return null; }
        }

        /***********************
         * Utils & UI helpers
         ***********************/
        function alertBox(msg){
            const banner = document.createElement('div');
            banner.className = 'fixed top-10 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-xl z-[20000] animate-fade-in font-bold';
            banner.innerText = msg;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 2500);
        }

        /* Escape html */
        function escapeHtml(str){ return (str+'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }

        /***********************
         * Render tracks
         ***********************/
        function renderTracks(data){
            const grid = document.getElementById('musicGrid');
            const mobileList = document.getElementById('mobileMusicList');

            if(grid) {
                grid.classList.remove('animate-spotify');
                void grid.offsetWidth; // trigger reflow
                grid.classList.add('animate-spotify');
                
                grid.innerHTML = data.map((track) => {
                    const originalIndex = tracks.findIndex(t => t.id === track.id);
                    const stats = trackStats[track.id] || { playCount: 0, lastPlayed: 0, lastListener: '', uniqueListeners: 0 };
                    const trendingBadge = stats.playCount > 5 ? `<div class="absolute top-4 right-4 bg-blue-500 text-white text-[10px] font-black px-2 py-1 rounded-lg z-20 shadow-lg">HOT</div>` : '';
                    const lastPlayedText = stats.lastPlayed ? getTimeAgo(stats.lastPlayed) : '';
                    
                    // Social text: "User and X others listened to this!"
                    let socialText = '';
                    if (stats.playCount > 0) {
                        const totalPlays = stats.playCount;
                        const uniquePeople = stats.uniqueListeners || 1;
                        const lastUser = stats.lastListener || 'Someone';
                        
                        if (lastUser === 'Someone') {
                            socialText = `<p class="text-[10px] text-blue-400/80 font-medium mt-1 truncate">Popular with listeners!</p>`;
                        } else if (uniquePeople <= 1) {
                            socialText = `<p class="text-[10px] text-blue-400/80 font-medium mt-1 truncate">${lastUser} is vibing to this!</p>`;
                        } else {
                            socialText = `<p class="text-[10px] text-blue-400/80 font-medium mt-1 truncate">${lastUser} and ${uniquePeople - 1} other ${uniquePeople - 1 === 1 ? 'person' : 'people'} listened!</p>`;
                        }
                    }
                    
                    return `
                    <div class="music-card glass p-6 rounded-[2rem] cursor-pointer group animate-fade-in relative" onclick="playTrack(${originalIndex})">
                        ${trendingBadge}
                        <div class="relative overflow-hidden rounded-2xl mb-5">
                            <img src="${track.img}" alt="${track.title}" class="w-full aspect-square object-cover group-hover:scale-110 transition-transform duration-700">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <div class="play-btn-float w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center text-white">
                                    <svg class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-lg truncate group-hover:text-blue-400 transition-colors">${escapeHtml(track.title)}</h4>
                                    <p class="text-xs text-slate-500 font-semibold uppercase">${escapeHtml(track.artist)}</p>
                                    ${socialText}
                                </div>
                                ${stats.playCount > 0 ? `<span class="text-[10px] text-slate-600 font-bold whitespace-nowrap">${stats.playCount} plays</span>` : ''}
                            </div>
                            ${lastPlayedText ? `<p class="text-[10px] text-slate-600 font-medium">Played ${lastPlayedText}</p>` : ''}
                        </div>
                    </div>
                `;}).join('');
            }

            if(mobileList) {
                mobileList.innerHTML = data.map((track) => {
                    const originalIndex = tracks.findIndex(t => t.id === track.id);
                    const stats = trackStats[track.id] || { playCount: 0, lastPlayed: 0, lastListener: '', uniqueListeners: 0 };
                    const lastPlayedText = stats.lastPlayed ? getTimeAgo(stats.lastPlayed) : '';
                    
                    // Social text: optimized for mobile
                    let socialText = '';
                    if (stats.playCount > 0) {
                        const totalPlays = stats.playCount;
                        const uniquePeople = stats.uniqueListeners || 1;
                        const lastUser = stats.lastListener || 'Someone';
                        
                        if (lastUser === 'Someone') {
                            socialText = `<p class="text-[9px] text-blue-400/70 truncate">Popular with listeners!</p>`;
                        } else if (uniquePeople <= 1) {
                            socialText = `<p class="text-[9px] text-blue-400/70 truncate">${lastUser} is vibing!</p>`;
                        } else {
                            socialText = `<p class="text-[9px] text-blue-400/70 truncate">${lastUser} & ${uniquePeople - 1} ${uniquePeople - 1 === 1 ? 'other' : 'others'}!</p>`;
                        }
                    }
                    
                    return `
                    <div class="flex items-center gap-4 p-3 bg-white/5 rounded-2xl active:scale-95 transition-transform border border-white/5" onclick="playTrack(${originalIndex})">
                        <div class="relative">
                            <img src="${track.img}" class="w-16 h-16 rounded-xl object-cover shadow-md">
                            ${stats.playCount > 5 ? `<div class="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-black flex items-center justify-center"><div class="w-1.5 h-1.5 bg-white rounded-full"></div></div>` : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white truncate text-base">${escapeHtml(track.title)}</h4>
                            <div class="flex flex-col">
                                <div class="flex items-center gap-2">
                                    <p class="text-xs text-slate-400 truncate">${escapeHtml(track.artist)}</p>
                                    ${lastPlayedText ? `<span class="text-[10px] text-slate-600">• ${lastPlayedText}</span>` : ''}
                                </div>
                                ${socialText}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <button class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white shadow-lg">
                                 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                            </button>
                            ${stats.playCount > 0 ? `<span class="text-[10px] text-slate-500 font-bold">${stats.playCount} plays</span>` : ''}
                        </div>
                    </div>
                `;}).join('');
            }
        }

        function getTimeAgo(ts) {
            const diff = Date.now() - ts;
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + 'm ago';
            const hours = Math.floor(mins / 60);
            if (hours < 24) return hours + 'h ago';
            return Math.floor(hours / 24) + 'd ago';
        }

        /***********************
         * Player functions
         ***********************/
        function playTrack(index){
            const track = tracks[index];
            if (!track) return;
            currentTrackIndex = index;
            incrementPlayCount(track.id);
            
            document.getElementById('player-bar').style.transform = 'translateY(0)';
            document.getElementById('player-img').src = track.img;
            
            // Initial local metadata
            document.getElementById('player-title').innerText = track.title;
            document.getElementById('player-artist').innerText = track.artist;
            
            audio.src = track.src;
            audio.play().catch(()=>{/* ignore autoplay errors */});
            updatePlayUI(true);
            animateVisualizer();

            // Always try to fetch/refresh metadata and lyrics
            fetchLyrics(track);
        }

        /***********************
         * Lyrics Logic (Genius API Integration)
         ***********************/
        async function fetchLyrics(track) {
            if (!lyricsVisible) return;
            const contentDiv = document.getElementById('lyrics-content');
            if (!contentDiv) return;

            if (track.lyrics) {
                renderFullLyrics(track.lyrics);
            } else {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-32 text-center">
                        <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-6">
                            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-white font-bold text-2xl mb-2">No lyrics available</h3>
                        <p class="text-slate-400 max-w-sm mb-8">Lyrics for this track haven't been added yet.</p>
                    </div>
                `;
            }
        }

        async function toggleLyrics() {
            const overlay = document.getElementById('lyrics-overlay');
            const btn = document.getElementById('lyrics-btn');
            if (!overlay) return;

            lyricsVisible = !lyricsVisible;
            
            if (lyricsVisible) {
                overlay.style.display = 'flex';
                overlay.offsetHeight;
                overlay.classList.add('show');
                btn?.classList.add('text-[#1db954]');
                
                const track = tracks[currentTrackIndex];
                await fetchLyrics(track);
            } else {
                overlay.classList.remove('show');
                btn?.classList.remove('text-[#1db954]');
                setTimeout(() => {
                    if (!lyricsVisible) {
                        overlay.style.display = 'none';
                        const contentDiv = document.getElementById('lyrics-content');
                        if (contentDiv) contentDiv.innerHTML = '';
                    }
                }, 500);
            }
        }

        function renderFullLyrics(text) {
            const contentDiv = document.getElementById('lyrics-content');
            if (!contentDiv) return;
            contentDiv.innerHTML = '';
            
            const lines = text.split('\n')
                .map(l => l.trim());
            
            for (const ln of lines) {
                if (ln === '') {
                    const spacer = document.createElement('div');
                    spacer.className = 'h-8';
                    contentDiv.appendChild(spacer);
                    continue;
                }
                const line = document.createElement('div');
                line.className = 'lyric-line active animate-spotify mb-6 text-2xl md:text-4xl font-bold tracking-tight text-white/90 hover:text-white transition-colors cursor-default';
                line.innerText = ln;
                contentDiv.appendChild(line);
            }
        }

        /***********************
         * Search & View logic
         ***********************/
        async function fetchSearchData(query) {
            // Simulate API delay
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simulate offline scenario if query is 'offline'
                    if (query === 'offline') {
                        reject(new Error('Network connection lost'));
                        return;
                    }

                    const filtered = tracks.filter(t => 
                        t.title.toLowerCase().includes(query) || 
                        t.artist.toLowerCase().includes(query)
                    );
                    resolve(filtered);
                }, 800); // 800ms "network" delay
            });
        }

        async function handleSearch(event) {
            const query = event.target.value.toLowerCase().trim();
            const isDesktop = event.target.id === 'searchInput';
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length === 0) {
                setLoading(false);
                if (currentView === 'search') {
                    renderTracks(tracks);
                }
                return;
            }

            // Show loading state
            setLoading(true);

            searchTimeout = setTimeout(async () => {
                try {
                    const results = await fetchSearchData(query);
                    
                    if (currentView !== 'search' && !isDesktop) {
                        // If we're searching from a different view on mobile, switch to search view
                        switchView('search');
                    }

                    renderTracks(results);
                    setLoading(false);
                    
                    if (results.length === 0) {
                        showSearchError("No songs found for your search.");
                    } else if (isDesktop) {
                        saveSearchHistory(query);
                    }
                } catch (error) {
                    setLoading(false);
                    showSearchError(error.message || "Something went wrong with the search.");
                }
            }, 500); // 500ms debounce
        }

        function saveSearchHistory(query) {
            if (!query) return;
            let history = JSON.parse(localStorage.getItem('jamusic_search_history') || '[]');
            history = [query, ...history.filter(h => h !== query)].slice(0, 5); // Keep last 5 unique searches
            localStorage.setItem('jamusic_search_history', JSON.stringify(history));
            updateSearchSuggestions();
        }

        function updateSearchSuggestions() {
            const history = JSON.parse(localStorage.getItem('jamusic_search_history') || '[]');
            const container = document.getElementById('searchSuggestions');
            if (!container) return;

            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = `
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <span class="text-[10px] uppercase tracking-widest text-slate-500 font-black">Recent Searches</span>
                    <button onclick="clearSearchHistory()" class="text-[10px] text-blue-500 hover:underline">Clear All</button>
                </div>
                ${history.map(h => `
                    <button onclick="applyHistorySearch('${escapeHtml(h)}')" class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm text-slate-300 transition-colors flex items-center gap-3">
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ${escapeHtml(h)}
                    </button>
                `).join('')}
            `;
            container.style.display = 'block';
        }

        function applyHistorySearch(query) {
            const input = document.getElementById('searchInput');
            if (input) {
                input.value = query;
                handleSearch({ target: input });
            }
            const container = document.getElementById('searchSuggestions');
            if (container) container.style.display = 'none';
        }

        function clearSearchHistory() {
            localStorage.removeItem('jamusic_search_history');
            updateSearchSuggestions();
        }

        function setLoading(isLoading) {
            const grid = document.getElementById('musicGrid');
            const mobileList = document.getElementById('mobileMusicList');
            const loaderHtml = `<div class="col-span-full py-20 flex flex-col items-center justify-center animate-pulse">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-slate-400 font-medium">Searching for vibes...</p>
            </div>`;

            if (isLoading) {
                if (grid) grid.innerHTML = loaderHtml;
                if (mobileList) mobileList.innerHTML = loaderHtml;
            }
        }

        function showSearchError(msg) {
            const grid = document.getElementById('musicGrid');
            const mobileList = document.getElementById('mobileMusicList');
            const errorHtml = `<div class="col-span-full py-20 flex flex-col items-center justify-center text-center">
                <svg class="w-16 h-16 text-slate-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 4h.01"></path></svg>
                <h4 class="text-xl font-bold text-slate-300 mb-2">Oops!</h4>
                <p class="text-slate-500">${escapeHtml(msg)}</p>
            </div>`;

            if (grid) grid.innerHTML = errorHtml;
            if (mobileList) mobileList.innerHTML = errorHtml;
        }

        async function switchView(view) {
            currentView = view;
            const gridTitle = document.getElementById('gridTitle');
            const mobileGridTitle = document.querySelector('#mobile-app h3');
            const mobileWelcomeBanner = document.getElementById('mobileWelcomeBanner');
            const mobileSearchContainer = document.getElementById('mobileSearchContainer');
            
            // Update UI active states
            updateNavUI(view);

            if (view === 'home') {
                if (gridTitle) gridTitle.innerText = 'Recommended';
                if (mobileGridTitle) mobileGridTitle.innerHTML = '<span class="w-1 h-6 bg-blue-500 rounded-full"></span>Recommended';
                if (mobileWelcomeBanner) mobileWelcomeBanner.style.display = 'block';
                if (mobileSearchContainer) mobileSearchContainer.style.display = 'none';
                renderTracks(tracks);
            } else if (view === 'trending') {
                if (gridTitle) gridTitle.innerText = 'Trending Now (Global)';
                if (mobileGridTitle) mobileGridTitle.innerHTML = '<span class="w-1 h-6 bg-blue-500 rounded-full"></span>Trending Now (Global)';
                if (mobileWelcomeBanner) mobileWelcomeBanner.style.display = 'none';
                if (mobileSearchContainer) mobileSearchContainer.style.display = 'none';
                
                // Fetch latest global stats before rendering trending
                await fetchGlobalStats();
                renderTracks(getTrendingTracks());
            } else if (view === 'search') {
                if (gridTitle) gridTitle.innerText = 'Search Results';
                if (mobileGridTitle) mobileGridTitle.innerHTML = '<span class="w-1 h-6 bg-blue-500 rounded-full"></span>Search Results';
                if (mobileWelcomeBanner) mobileWelcomeBanner.style.display = 'none';
                if (mobileSearchContainer) mobileSearchContainer.style.display = 'block';
                
                // On mobile, focus search if we have a search input
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                if (mobileSearchInput) {
                    mobileSearchInput.focus();
                }
                renderTracks(tracks);
            }
        }

        function updateNavUI(view) {
            // Desktop Sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('nav-active', 'text-white', 'bg-white/5');
                item.classList.add('text-slate-400');
                
                const text = item.innerText.toLowerCase();
                if ((view === 'home' && text.includes('discover')) || 
                    (view === 'trending' && text.includes('trending'))) {
                    item.classList.add('nav-active', 'text-white');
                    item.classList.remove('text-slate-400');
                }
            });

            // Mobile Bottom Nav
            const mobileBtns = document.querySelectorAll('#mobile-app .fixed.bottom-0 button');
            mobileBtns.forEach(btn => {
                const span = btn.querySelector('span');
                if (!span) return;
                
                btn.classList.remove('text-blue-400');
                btn.classList.add('text-slate-500');
                
                const text = span.innerText.toLowerCase();
                if (text === view) {
                    btn.classList.add('text-blue-400');
                    btn.classList.remove('text-slate-500');
                }
            });
        }

        function togglePlay(){
            if (!audio.src) {
                playTrack(0);
                return;
            }
            if (audio.paused) { audio.play().catch(()=>{}); updatePlayUI(true); } 
            else { audio.pause(); updatePlayUI(false); }
        }

        function updatePlayUI(playing){
            isPlaying = playing;
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            if (playIcon && pauseIcon) {
                playIcon.classList.toggle('hidden', playing);
                pauseIcon.classList.toggle('hidden', !playing);
            }
        }

        function nextTrack(){
            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            playTrack(currentTrackIndex);
        }

        function prevTrack(){
            currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            playTrack(currentTrackIndex);
        }

        let syncAnimationId = null;
        function startSyncLoop() {
            if (syncAnimationId) cancelAnimationFrame(syncAnimationId);
            
            function sync() {
                if (!audio.paused) {
                    updatePlayerUIProgress();
                }
                syncAnimationId = requestAnimationFrame(sync);
            }
            syncAnimationId = requestAnimationFrame(sync);
        }

        function updatePlayerUIProgress() {
            const seekSlider = document.getElementById('seek-slider');
            const progressFill = document.getElementById('progress-bar-fill');
            const seekThumb = document.getElementById('seek-thumb');
            
            if (!seekSlider) return;
            if (audio.duration) {
                const currentTime = audio.currentTime;
                const duration = audio.duration;
                const percentage = (currentTime / duration) * 100;
                
                seekSlider.max = Math.floor(duration);
                seekSlider.value = Math.floor(currentTime);
                
                if (progressFill) progressFill.style.width = `${percentage}%`;
                if (seekThumb) seekThumb.style.left = `${percentage}%`;

                const c = document.getElementById('curr-time');
                const d = document.getElementById('dur-time');
                if (c) c.innerText = formatTime(currentTime);
                if (d) d.innerText = formatTime(duration);
            }
        }

        // Initialize sync loop
        startSyncLoop();

        // When track ends, either repeat or next
        audio.onended = () => {
            if (repeatTracks) {
                audio.currentTime = 0;
                audio.play().catch(()=>{});
            } else {
                nextTrack();
            }
        };

        // seek & volume wiring (safe guard)
        document.addEventListener('DOMContentLoaded', () => {
            const seek = document.getElementById('seek-slider');
            const progressFill = document.getElementById('progress-bar-fill');
            const seekThumb = document.getElementById('seek-thumb');

            if (seek) {
                seek.oninput = (e) => { 
                    const val = e.target.value;
                    audio.currentTime = val; 
                    if (audio.duration) {
                        const percentage = (val / audio.duration) * 100;
                        if (progressFill) progressFill.style.width = `${percentage}%`;
                        if (seekThumb) seekThumb.style.left = `${percentage}%`;
                    }
                };
            }

            const vol = document.getElementById('volume-slider');
            const volFill = document.getElementById('volume-bar-fill');
            const volIcon = document.getElementById('volume-icon');

            if (vol) {
                vol.oninput = (e) => { 
                    const val = e.target.value;
                    audio.volume = val / 100; 
                    if (volFill) volFill.style.width = `${val}%`;
                    updateVolumeIcon(val);
                };
            }

            const muteBtn = document.getElementById('mute-btn');
            if (muteBtn) {
                muteBtn.onclick = () => {
                    if (audio.volume > 0) {
                        audio.oldVol = audio.volume;
                        audio.volume = 0;
                        if (vol) vol.value = 0;
                        if (volFill) volFill.style.width = '0%';
                        updateVolumeIcon(0);
                    } else {
                        const target = audio.oldVol || 1;
                        audio.volume = target;
                        if (vol) vol.value = target * 100;
                        if (volFill) volFill.style.width = `${target * 100}%`;
                        updateVolumeIcon(target * 100);
                    }
                };
            }

            renderTracks(tracks);
        });

        function updateVolumeIcon(val) {
            const icon = document.getElementById('volume-icon');
            if (!icon) return;
            if (val == 0) {
                icon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path>';
            } else if (val < 50) {
                icon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm11.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"></path>';
            } else {
                icon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>';
            }
        }

        function formatTime(secs){
            const min = Math.floor(secs / 60);
            const sec = Math.floor(secs % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function animateVisualizer(){
            const bars = document.querySelectorAll('.visualizer-bar');
            bars.forEach(bar => {
                if (isPlaying) {
                    const randomHeight = Math.random() * 80 + 20;
                    bar.style.height = randomHeight + '%';
                } else {
                    bar.style.height = '20%';
                }
            });
            if (isPlaying) setTimeout(animateVisualizer, 150);
        }

        /***********************
         * Auth & UI state
         ***********************/
        function toggleProfileMenu(){
            const dd = document.getElementById('profile-dropdown');
            const mdd = document.getElementById('mobile-profile-dropdown');
            if (dd) dd.classList.toggle('active');
            if (mdd) mdd.classList.toggle('active');
        }

        window.onclick = (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            const trigger = document.getElementById('profile-trigger');
            const mDropdown = document.getElementById('mobile-profile-dropdown');
            const mTrigger = document.getElementById('mobile-profile-trigger');
            const searchSuggestions = document.getElementById('searchSuggestions');
            const searchInput = document.getElementById('searchInput');

            if (dropdown && trigger && !trigger.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
            if (mDropdown && mTrigger && !mTrigger.contains(e.target) && !mDropdown.contains(e.target)) {
                mDropdown.classList.remove('active');
            }
            if (searchSuggestions && searchInput && !searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        };

        function toggleAuthMode(mode){
            window.authMode = mode;
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            if (loginTab && signupTab) {
                loginTab.classList.toggle('active', mode === 'login');
                signupTab.classList.toggle('active', mode === 'signup');
            }
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) submitBtn.innerText = mode === 'login' ? 'Sign In' : 'Create Account';
        }

        // handleAuth is now implemented in the module script below

        async function showApp(user){
            if (!user) return;
            const authOverlay = document.getElementById('auth-overlay');
            if (authOverlay) {
                authOverlay.style.opacity = '0';
                authOverlay.style.pointerEvents = 'none'; // Fix: prevent phantom clicks
            }
            const userDisplay = document.getElementById('user-display');
            const dropdownName = document.getElementById('dropdown-name');
            const dropdownEmail = document.getElementById('dropdown-email');
            
            // update mobile dropdowns too
            const mUserDisplay = document.getElementById('mobile-user-display');
            const mDropdownName = document.getElementById('mobile-dropdown-name');
            const mDropdownEmail = document.getElementById('mobile-dropdown-email');
            
            if (userDisplay) userDisplay.innerText = user.name;
            if (dropdownName) dropdownName.innerText = user.name;
            if (dropdownEmail) dropdownEmail.innerText = user.email;
            
            if (mUserDisplay) mUserDisplay.innerText = user.name;
            if (mDropdownName) mDropdownName.innerText = user.name;
            if (mDropdownEmail) mDropdownEmail.innerText = user.email;

            updateViewMode();

            // Fetch global stats for badges/trending display
            await fetchGlobalStats();
            
            renderTracks(tracks);
            setTimeout(() => { if (authOverlay) authOverlay.style.display = 'none'; }, 600);
        }

        function updateViewMode() {
            const isMobile = window.innerWidth <= 768;
            const desktopApp = document.getElementById('main-app');
            const mobileApp = document.getElementById('mobile-app');
            const playerBar = document.getElementById('player-bar');

            if (isMobile) {
                // Mobile Mode
                if (mobileApp) {
                    mobileApp.style.display = 'block';
                    // small delay to allow display block to apply before opacity transition
                    requestAnimationFrame(() => {
                        mobileApp.classList.remove('hidden-state');
                        mobileApp.style.opacity = '1';
                        mobileApp.style.pointerEvents = 'auto';
                    });
                }
                if (desktopApp) desktopApp.style.display = 'none';
                
                // Adjust player bar to sit above bottom nav
                if (playerBar) {
                    // Check if player is active (translatedY)
                    // We just set the style.bottom
                    playerBar.style.bottom = 'calc(80px + env(safe-area-inset-bottom, 20px))'; 
                    playerBar.style.width = '94%';
                    playerBar.style.left = '3%';
                    playerBar.style.borderRadius = '20px';
                    playerBar.style.border = '1px solid rgba(255,255,255,0.1)';
                    playerBar.style.backdropFilter = 'blur(20px)';
                }
            } else {
                // Desktop Mode
                if (desktopApp) {
                    desktopApp.style.display = 'block';
                    requestAnimationFrame(() => {
                        desktopApp.classList.remove('hidden-state');
                        desktopApp.style.opacity = '1';
                        desktopApp.style.pointerEvents = 'auto';
                    });
                }
                if (mobileApp) mobileApp.style.display = 'none';
                
                if (playerBar) {
                    playerBar.style.bottom = '0';
                    playerBar.style.width = '100%';
                    playerBar.style.left = '0';
                    playerBar.style.borderRadius = '0';
                    playerBar.style.border = '';
                    playerBar.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                }
            }
        }

        window.addEventListener('resize', () => {
             // check if logged in by checking auth overlay opacity or localStorage
             // simplistic check: if auth overlay is hidden/opacity 0
             const authOverlay = document.getElementById('auth-overlay');
             if (authOverlay && getComputedStyle(authOverlay).opacity === '0') {
                 updateViewMode();
             }
        });

        // logout is now implemented in the module script below

        /***********************
         * Repeat toggle
         ***********************/
        function toggleRepeat(){
            repeatTracks = !repeatTracks;
            const el = document.getElementById('repeat-icon');
            if (el) {
                if (repeatTracks) el.style.color = 'var(--accent)';
                else el.style.color = '';
            }
            alertBox(repeatTracks ? 'Repeat ON' : 'Repeat OFF');
        }

        /***********************
         * Display name flow (kept)
         ***********************/
        function isEmailLike(name){
            if (!name) return false;
            return /@.+\./.test(name);
        }

        /***********************
         * DOM wiring on ready
         ***********************/
        document.addEventListener('DOMContentLoaded', () => {
            // Restore saved user optimistically for better UX
            // We'll let onAuthStateChanged handle the final authority, 
            // but this helps prevent a flash of login screen.
            const savedUser = localStorage.getItem('jamusic_user');
            if (savedUser) {
                try {
                    showApp(JSON.parse(savedUser));
                } catch(e) {
                    localStorage.removeItem('jamusic_user');
                }
            }

            // settings wiring
            const settingsBtn = document.getElementById('account-settings-btn');
            const settingsOverlay = document.getElementById('settings-overlay');
            const settingsPanel = document.getElementById('settings-sidebar');
            const settingsClose = document.getElementById('settings-close');

            if (settingsBtn) settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (settingsPanel) settingsPanel.classList.add('open');
                if (settingsOverlay) settingsOverlay.classList.add('show');
                document.body.classList.add('no-scroll');
                const dd = document.getElementById('profile-dropdown'); if (dd) dd.classList.remove('active');
            });
            if (settingsClose) settingsClose.addEventListener('click', () => { if (settingsPanel) settingsPanel.classList.remove('open'); if (settingsOverlay) settingsOverlay.classList.remove('show'); document.body.classList.remove('no-scroll'); });
            if (settingsOverlay) settingsOverlay.addEventListener('click', () => { if (settingsPanel) settingsPanel.classList.remove('open'); if (settingsOverlay) settingsOverlay.classList.remove('show'); document.body.classList.remove('no-scroll'); });

            // settings tabs
            const tabGeneral = document.getElementById('tab-general'), 
                  tabZoom = document.getElementById('tab-zoom');

            if (tabGeneral) tabGeneral.addEventListener('click', () => { 
                document.getElementById('settings-general').classList.remove('hidden'); 
                document.getElementById('settings-zoom').classList.add('hidden'); 
                tabGeneral.classList.add('active'); 
                tabZoom.classList.remove('active'); 
            });
            if (tabZoom) tabZoom.addEventListener('click', () => { 
                document.getElementById('settings-general').classList.add('hidden'); 
                document.getElementById('settings-zoom').classList.remove('hidden'); 
                tabGeneral.classList.remove('active'); 
                tabZoom.classList.add('active'); 
            });

            // volume sync
            const vslider = document.getElementById('settings-volume');
            if (vslider) {
                vslider.value = Math.round((audio.volume || 1) * 100);
                vslider.addEventListener('input', (e) => {
                    audio.volume = e.target.value / 100;
                    const mainVol = document.getElementById('volume-slider');
                    if (mainVol) mainVol.value = e.target.value;
                });
            }
            const mainVol = document.getElementById('volume-slider');
            if (mainVol) mainVol.addEventListener('input', (e) => {
                audio.volume = e.target.value / 100;
                if (vslider) vslider.value = e.target.value;
            });

            // zoom slider
            const zoomSlider = document.getElementById('settings-zoom-slider');
            if (zoomSlider) {
                const saved = localStorage.getItem('jamusic_zoom');
                if (saved) document.body.style.zoom = saved;
                zoomSlider.value = document.body.style.zoom || 1;
                zoomSlider.addEventListener('input', (e) => {
                    document.body.style.zoom = e.target.value;
                    try { localStorage.setItem('jamusic_zoom', e.target.value); } catch(e){}
                });
            }

            // theme buttons restore
            const themeLightBtn = document.getElementById('theme-light-btn');
            const themeDarkBtn = document.getElementById('theme-dark-btn');
            try {
                const savedTheme = localStorage.getItem('jamusic_theme');
                if (savedTheme) {
                    if (savedTheme === 'light') { document.body.style.backgroundColor = '#f8fafc'; document.body.style.color = '#020617'; }
                    else { document.body.style.backgroundColor = 'var(--bg-dark)'; document.body.style.color = '#f8fafc'; }
                }
            } catch(e){}
            if (themeLightBtn) themeLightBtn.addEventListener('click', () => { document.body.style.backgroundColor = '#f8fafc'; document.body.style.color = '#020617'; try{ localStorage.setItem('jamusic_theme', 'light'); }catch(e){} });
            if (themeDarkBtn) themeDarkBtn.addEventListener('click', () => { document.body.style.backgroundColor = 'var(--bg-dark)'; document.body.style.color = '#f8fafc'; try{ localStorage.setItem('jamusic_theme', 'dark'); }catch(e){} });

            // display name wiring
            const displayNameBtn = document.getElementById('display-name-btn');
            const dnOverlay = document.getElementById('displayname-overlay');
            const dnModal = document.getElementById('displayname-modal');
            const dnWarningView = document.getElementById('dn-warning-view');
            const dnInputView = document.getElementById('dn-input-view');
            const dnYes = document.getElementById('dn-yes');
            const dnNo = document.getElementById('dn-no');
            const dnCancel = document.getElementById('dn-cancel');
            const dnSubmit = document.getElementById('dn-submit');
            const dnInput = document.getElementById('dn-input');
            const dnError = document.getElementById('dn-error');

            if (displayNameBtn) {
                displayNameBtn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const dd = document.getElementById('profile-dropdown'); if (dd) dd.classList.remove('active');

                    let currentName = '';
                    try { const su = localStorage.getItem('jamusic_user'); if (su) currentName = JSON.parse(su).name || ''; } catch(e){}

                    if (dnOverlay) dnOverlay.classList.add('show');
                    if (dnModal) dnModal.classList.add('show');
                    document.body.classList.add('no-scroll');

                    if (isEmailLike(currentName)) {
                        if (dnWarningView) dnWarningView.style.display = 'block';
                        if (dnInputView) dnInputView.style.display = 'none';
                    } else {
                        if (dnWarningView) dnWarningView.style.display = 'none';
                        if (dnInputView) dnInputView.style.display = 'block';
                    }
                });
            }

            if (dnNo) dnNo.addEventListener('click', () => { if (dnOverlay) dnOverlay.classList.remove('show'); if (dnModal) dnModal.classList.remove('show'); document.body.classList.remove('no-scroll'); });
            if (dnYes) dnYes.addEventListener('click', () => { if (dnWarningView) dnWarningView.style.display = 'none'; if (dnInputView) dnInputView.style.display = 'block'; if (dnError) dnError.style.display = 'none'; if (dnInput) dnInput.value = ''; });
            if (dnCancel) dnCancel.addEventListener('click', () => { if (dnOverlay) dnOverlay.classList.remove('show'); if (dnModal) dnModal.classList.remove('show'); document.body.classList.remove('no-scroll'); });
            if (dnOverlay) dnOverlay.addEventListener('click', (e) => { if (e.target === dnOverlay) { if (dnOverlay) dnOverlay.classList.remove('show'); if (dnModal) dnModal.classList.remove('show'); document.body.classList.remove('no-scroll'); }});
            if (dnSubmit) dnSubmit.addEventListener('click', () => {
                const val = (dnInput.value || '').trim();
                const validRegex = /^[A-Za-z0-9 _-]{2,30}$/;
                if (!validRegex.test(val)) { if (dnError) dnError.style.display = 'block'; return; }
                const userDisplay = document.getElementById('user-display');
                const ddn = document.getElementById('dropdown-name');
                if (userDisplay) userDisplay.innerText = val;
                if (ddn) ddn.innerText = val;
                try {
                    const su = localStorage.getItem('jamusic_user');
                    if (su) {
                        const obj = JSON.parse(su);
                        obj.name = val;
                        localStorage.setItem('jamusic_user', JSON.stringify(obj));
                    } else {
                        localStorage.setItem('jamusic_user', JSON.stringify({ name: val, email: '' }));
                    }
                } catch(e){}
                if (dnModal) dnModal.classList.remove('show');
                setTimeout(() => { if (dnOverlay) dnOverlay.classList.remove('show'); document.body.classList.remove('no-scroll'); if (dnModal) dnModal.classList.add('show'); }, 220);
            });

            // wire profile dropdown close on outside
            const profileDropdown = document.getElementById('profile-dropdown');
            const accountBtn = document.getElementById('account-settings-btn');
            if (accountBtn && profileDropdown) {
                accountBtn.addEventListener('click', () => profileDropdown.classList.remove('active'));
            }
        });

    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, child, get, update, increment, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your web app's Firebase configuration
        // NOTE: Replace these placeholders with your actual Firebase config from the console
        const firebaseConfig = {
            apiKey: "AIzaSyApKLZIjUZSQnKJCngvp0KZPYJf3zBNaCc",
            authDomain: "jamusic-v2.firebaseapp.com",
            projectId: "jamusic-v2",
            databaseURL: "https://jamusic-v2-default-rtdb.firebaseio.com",
            storageBucket: "jamusic-v2.firebasestorage.app",
            messagingSenderId: "765002295434",
            appId: "1:765002295434:web:a4c9ba98c68dbcd84f2573"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Expose to global for use in main script
        window.db = db;
        window.dbRef = ref(db);
        window.dbIncrement = increment;
        window.dbUpdate = update;
        window.dbRefPath = ref;
        window.dbGet = get;
        window.dbChild = child;
        window.dbOnValue = onValue;

        // Expose functions to global scope for button clicks
        window.handleAuth = async function() {
            const emailEl = document.getElementById('auth-email');
            const passEl = document.getElementById('auth-pass');
            const rememberEl = document.getElementById('remember-me');
            const submitBtn = document.getElementById('submit-btn');

            if (!emailEl || !passEl) return;
            const email = emailEl.value.trim();
            const pass = passEl.value.trim();
            const remember = rememberEl ? rememberEl.checked : false;

            if (!email || !pass) {
                alertBox("Please fill in all fields.");
                return;
            }

            // Show loading state
            const originalText = submitBtn.innerText;
            const currentMode = window.authMode || 'login';
            submitBtn.innerText = currentMode === 'login' ? 'Signing In...' : 'Creating Account...';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';

            try {
                let userCredential;
                if (currentMode === 'login') {
                    userCredential = await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                }
                
                const user = userCredential.user;
                const userData = { email: user.email, name: user.email.split('@')[0], uid: user.uid };
                
                // If remember me is NOT checked, we still store in localStorage for the session
                // but Firebase persistence is already set to LOCAL by default.
                // We'll update the global app state.
                localStorage.setItem('jamusic_user', JSON.stringify(userData));
                window.showApp(userData);
            } catch (error) {
                console.error("Auth error:", error.code, error.message);
                let friendlyMsg = "Warning: The credentials you put doesn't match in our database! ";
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    friendlyMsg += "Maybe the email is wrong?";
                } else if (error.code === 'auth/wrong-password') {
                    friendlyMsg += "Maybe the password is wrong?";
                } else if (error.code === 'auth/invalid-credential') {
                    friendlyMsg += "Maybe the email or password is wrong?";
                } else if (error.code === 'auth/email-already-in-use') {
                    friendlyMsg = "This email is already registered. Try logging in instead!";
                } else if (error.code === 'auth/weak-password') {
                    friendlyMsg = "Password should be at least 6 characters.";
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMsg = "Network error. Please check your internet connection.";
                } else {
                    friendlyMsg += "Please check your connection or try again.";
                }
                
                alertBox(friendlyMsg);
            } finally {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
            }
        };

        window.logout = async function() {
            try {
                await auth.signOut();
                localStorage.removeItem('jamusic_user');
                location.reload();
            } catch (error) {
                console.error("Logout error:", error);
                localStorage.removeItem('jamusic_user');
                location.reload(); // Fallback
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userData = { email: user.email, name: user.email.split('@')[0], uid: user.uid };
                localStorage.setItem('jamusic_user', JSON.stringify(userData));
                window.showApp(userData);
            } else {
                // If no Firebase user, but we have local data, it might be an expired session
                const localUser = localStorage.getItem('jamusic_user');
                if (localUser) {
                    localStorage.removeItem('jamusic_user');
                    location.reload(); // Force clean state
                }
            }
        });
    </script>
</body>
</html>
